name: Generate VHS Demos

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - .tapes/**
      - cmd/**
      - internal/**
      - go.mod
      - go.sum
  workflow_dispatch:

jobs:
  find-tapes:
    runs-on: ubuntu-latest
    outputs:
      tapes: ${{ steps.find.outputs.tapes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed/new tape files
        id: find
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # Get changed and new .tape files in PR
            tapes=$(git diff --name-only --diff-filter=AM origin/${{ github.base_ref }}...HEAD | grep '\.tape$' | grep -v '/assets/' || echo "")
          else
            # For workflow_dispatch, get all tape files
            tapes=$(find .tapes -name "*.tape" -not -path "*/assets/*" -type f)
          fi

          if [ -z "$tapes" ]; then
            echo "tapes=[]" >> $GITHUB_OUTPUT
            echo "No changed/new tape files found"
          else
            # Format as JSON array
            tapes_json=$(echo "$tapes" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "tapes=$tapes_json" >> $GITHUB_OUTPUT
            echo "Found tapes: $tapes_json"
          fi

  generate-demos:
    needs: find-tapes
    if: needs.find-tapes.outputs.tapes != '[]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        tape: ${{ fromJson(needs.find-tapes.outputs.tapes) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.24"

      - name: Build calculator
        run: go build -o calc ./cmd/calculator

      - name: Generate demo with VHS
        uses: charmbracelet/vhs-action@v1
        with:
          path: ${{ matrix.tape }}

      - name: Commit generated GIF
        uses: stefanzweifel/git-auto-commit-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          commit_message: "Update VHS demo for ${{ matrix.tape }}"
          file_pattern: ".tapes/assets/*.gif"
          commit_user_name: vhs-action ðŸ“¼
          commit_user_email: actions@github.com
          commit_author: vhs-action ðŸ“¼ <actions@github.com>

  comment-pr:
    needs: [find-tapes, generate-demos]
    if: github.event_name == 'pull_request' && needs.find-tapes.outputs.tapes != '[]'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Find generated demos
        id: demos
        run: |
          demos=$(find .tapes/assets -name "*.gif" -type f | sort)
          if [ -z "$demos" ]; then
            echo "files=" >> $GITHUB_OUTPUT
          else
            files=$(echo "$demos" | xargs -I {} basename {} | jq -R -s -c 'split("\n")[:-1]')
            echo "files=$files" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const files = ${{ steps.demos.outputs.files || '[]' }};

            if (files.length === 0) {
              console.log('No demo files found');
              return;
            }

            let body = `## ðŸŽ¬ VHS Demo Generation\n\n`;
            body += `Generated ${files.length} demo(s) from changed/new tape files:\n\n`;

            files.forEach(file => {
              const path = `.tapes/assets/${file}`;
              body += `### ${file}\n`;
              body += `![${file}](${path})\n\n`;
            });

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
